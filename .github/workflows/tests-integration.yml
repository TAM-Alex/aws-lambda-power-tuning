name: aws-lambda-power-tuning-integration-tests
run-name: ${{ github.actor }} is running integration tests
permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - 'master'
  pull_request:

env:
  # stack names are reused across jobs
  STACK_NAME_DEFAULTS: aws-lpt-gh-defaults-${GITHUB_REF_NAME/\//-}
  STACK_NAME_S3: aws-lpt-gh-s3-${GITHUB_REF_NAME/\//-}
  STACK_NAME_VPC: aws-lpt-gh-vpc-${GITHUB_REF_NAME/\//-}
  STACK_NAME_LAMBDA_RESOURCE: aws-lpt-gh-lambda-resource-${GITHUB_REF_NAME/\//-}
  STACK_NAME_CUSTOM_PARAMS: aws-lpt-gh-custom-params-${GITHUB_REF_NAME/\//-}

  # deployment parameters are reused across jobs
  PowerValues: 512,1024,1536 # shorter list
  VisualizationURL: https://my-custom-url.io/
  LambdaResource: 'arn:aws:lambda:eu-west-1:*:function:*' # specific region
  TotalExecutionTimeout: '900' #max value
  PermissionsBoundary: arn:aws:iam::aws:policy/AdministratorAccess
  S3Bucket: lpt-payloads # existing bucket
  S3Key: "payload.json" # only allow this object
  LayerSdkName: custom-layer-name
  LogGroupRetentionInDays: 7
  SecurityGroupIds: sg-06ad5b959d0ce9f57 # existing SG
  SubnetIDs: subnet-0126a3daed78354c7,subnet-00e2995006f41811e # existing subnets

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16.x
          cache: 'npm'
      - run: npm ci
      - uses: aws-actions/setup-sam@v2
        with:
          use-installer: true
      #- run: sam validate
      - run: sam build --use-container
      - uses: actions/upload-artifact@v2
        with:
          name: sam-build-artifacts
          path: ${{ github.workspace }}/.aws-sam

  deploy:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # this will deploy the 5 stacks in parallel,
        # without defining each job individually
        # (see the conditional trick below)
        stack: ['default', 'vpc', 's3', 'resource', 'custom']
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          audience: sts.amazonaws.com
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
      - uses: aws-actions/setup-sam@v2
        with:
          use-installer: true
      - uses: actions/download-artifact@v2
        with:
          name: sam-build-artifacts
      # deploy with default params
      - run: |
            [[ "${{ matrix.stack }}" = "default" ]] && sam deploy --no-confirm-changeset --no-fail-on-empty-changeset --s3-bucket ${{ secrets.AWS_S3_BUCKET }} --capabilities CAPABILITY_IAM --region ${{ secrets.AWS_REGION }} \
             --stack-name $STACK_NAME_DEFAULTS

      # deploy with VPC params
      - run: |
            [[ "${{ matrix.stack }}" = "vpc" ]] && sam deploy --no-confirm-changeset --no-fail-on-empty-changeset --s3-bucket ${{ secrets.AWS_S3_BUCKET }} --capabilities CAPABILITY_IAM --region ${{ secrets.AWS_REGION }} \
             --stack-name $STACK_NAME_VPC \
             --parameter-overrides subnetIds=$SubnetIDs securityGroupIds=$SecurityGroupIds

      # deploy with S3 payload params
      - run: |
            [[ "${{ matrix.stack }}" = "s3" ]] && sam deploy --no-confirm-changeset --no-fail-on-empty-changeset --s3-bucket ${{ secrets.AWS_S3_BUCKET }} --capabilities CAPABILITY_IAM --region ${{ secrets.AWS_REGION }} \
             --stack-name $STACK_NAME_S3 \
             --parameter-overrides payloadS3Bucket=$S3Bucket payloadS3Key=$S3Key

      # deploy with regional limitation (via Lambda Resource)
      - run: |
            [[ "${{ matrix.stack }}" = "resource" ]] && sam deploy --no-confirm-changeset --no-fail-on-empty-changeset --s3-bucket ${{ secrets.AWS_S3_BUCKET }} --capabilities CAPABILITY_IAM --region ${{ secrets.AWS_REGION }} \
             --stack-name $STACK_NAME_LAMBDA_RESOURCE \
             --parameter-overrides lambdaResource=$LambdaResource


      # deploy with a bunch of custom parameters
      - run: |
            [[ "${{ matrix.stack }}" = "custom" ]] && sam deploy --no-confirm-changeset --no-fail-on-empty-changeset --s3-bucket ${{ secrets.AWS_S3_BUCKET }} --capabilities CAPABILITY_IAM --region ${{ secrets.AWS_REGION }} \
             --stack-name $STACK_NAME_CUSTOM_PARAMS \
             --parameter-overrides \
              PowerValues=$PowerValues \
              visualizationURL=$VisualizationURL \
              totalExecutionTimeout=$TotalExecutionTimeout \
              layerSdkName=$LayerSdkName \
              logGroupRetentionInDays=$LogGroupRetentionInDays \
              permissionsBoundary=$PermissionsBoundary

  test:
    needs: deploy
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # this will test the 5 stacks in parallel,
        # without defining each job individually
        # (see the conditional trick below)
        stack: ['default', 'vpc', 's3', 'resource', 'custom']
    steps:
      - run: echo "Running tests for stack ${{ matrix.stack }}"